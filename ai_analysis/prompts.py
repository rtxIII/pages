# coding=utf-8
"""
AI Prompt æ¨¡æ¿ç®¡ç†

å®šä¹‰ç”¨äºé‡‘èå¸‚åœºåˆ†æçš„ LLM Prompt æ¨¡æ¿
"""

from typing import List, Dict


class PromptTemplates:
    """Prompt æ¨¡æ¿é›†åˆ"""
    
    # ç³»ç»Ÿè§’è‰²å®šä¹‰
    SYSTEM_ROLE = """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„é‡‘èå¸‚åœºåˆ†æå¸ˆï¼Œæ“…é•¿ä»çƒ­ç‚¹æ–°é—»ä¸­æå–å¸‚åœºä¿¡å·ã€‚
ä½ éœ€è¦åˆ†ææ–°é—»å¯¹ä¸åŒå¸‚åœºæ¿å—çš„å½±å“ï¼Œå¹¶ç»™å‡ºå®¢è§‚ã€ç†æ€§çš„æŠ•èµ„å»ºè®®ã€‚

åˆ†æç»´åº¦ï¼š
1. äº‹ä»¶æ€§è´¨ï¼šåˆ©å¥½/åˆ©ç©º/ä¸­æ€§
2. å½±å“ç¨‹åº¦ï¼š1-10åˆ†ï¼ˆ10åˆ†ä¸ºæœ€é«˜å½±å“ï¼‰
3. ç½®ä¿¡åº¦ï¼šé«˜/ä¸­/ä½
4. ç›¸å…³æ¿å—ï¼šç§‘æŠ€ã€é‡‘èã€æ¶ˆè´¹ã€åŒ»ç–—ç­‰
5. æ—¶é—´è·¨åº¦ï¼šçŸ­æœŸï¼ˆ1-3å¤©ï¼‰ã€ä¸­æœŸï¼ˆ1-2å‘¨ï¼‰ã€é•¿æœŸï¼ˆ1ä¸ªæœˆ+ï¼‰
"""

    # å¸‚åœºå½±å“åˆ†æ Prompt
    MARKET_ANALYSIS_PROMPT = """è¯·åˆ†æä»¥ä¸‹çƒ­ç‚¹æ–°é—»å¯¹é‡‘èå¸‚åœºçš„å½±å“ï¼š

## æ–°é—»æ•°æ®
æ—¥æœŸ: {date}
çƒ­è¯åˆ†ç»„: {hot_keywords}

{news_items}

## å¯ç”¨å·¥å…·

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·è·å–å®æ—¶å¸‚åœºæ•°æ®ï¼Œå¢å¼ºåˆ†æçš„å‡†ç¡®æ€§ï¼š

1. **evaluate_sector_impact** - å¯¹æ¯ä¸ªæ¿å—è¿›è¡Œç»“æ„åŒ–è¯„ä¼°ï¼ˆå¿…é¡»ä½¿ç”¨ï¼‰
2. **get_stock_price** - è·å–ç›¸å…³è‚¡ç¥¨çš„å®æ—¶ä»·æ ¼å’Œæ¶¨è·Œå¹…
3. **get_index_price** - è·å–å¤§ç›˜æŒ‡æ•°æ•°æ®ï¼ˆå¦‚ä¸Šè¯æŒ‡æ•° 000001ã€æ·±è¯æˆæŒ‡ 399001ï¼‰
4. **calculate_rsi** - è®¡ç®—è‚¡ç¥¨ RSI æŠ€æœ¯æŒ‡æ ‡
5. **search_stock** - æ ¹æ®å…³é”®è¯æœç´¢ç›¸å…³è‚¡ç¥¨ä»£ç 

**è¯·åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼š**
- ä½¿ç”¨ evaluate_sector_impact å¯¹æ¯ä¸ªèšç„¦æ¿å—è¿›è¡Œè¯„ä¼°
- ä½¿ç”¨ get_index_price è·å–å½“æ—¥å¤§ç›˜æŒ‡æ•°æ•°æ®
- å¦‚æœæ–°é—»æåˆ°å…·ä½“å…¬å¸ï¼Œä½¿ç”¨ search_stock æ‰¾åˆ°è‚¡ç¥¨ä»£ç ï¼Œç„¶åç”¨ get_stock_price è·å–å®æ—¶ä»·æ ¼

## åˆ†æè¦æ±‚

1. **æ ¸å¿ƒè¦ç‚¹æå–**ï¼ˆ3-5æ¡ï¼‰
   - è¯†åˆ«æœ€é‡è¦çš„å¸‚åœºå½±å“äº‹ä»¶
   - æ¯æ¡è¦ç‚¹åŒ…å«ï¼šäº‹ä»¶ + å½±å“æ–¹å‘ + ç®€è¦åŸå› 

2. **æ¿å—å½±å“è¯„ä¼°**
   - èšç„¦æ¿å—ï¼š{focus_sectors}
   - å¯¹æ¯ä¸ªç›¸å…³æ¿å—ä½¿ç”¨ evaluate_sector_impact å·¥å…·è¿›è¡Œè¯„ä¼°
   - è¾“å‡ºè¡¨æ ¼æ ¼å¼

3. **å®æ—¶å¸‚åœºæ•°æ®**ï¼ˆå¦‚æœè·å–åˆ°ï¼‰
   - æ˜¾ç¤ºå¤§ç›˜æŒ‡æ•°å’Œç›¸å…³è‚¡ç¥¨çš„å®æ—¶ä»·æ ¼
   - ç»“åˆæŠ€æœ¯æŒ‡æ ‡åˆ†æ

4. **æŠ•èµ„å»ºè®®**
   - çŸ­æœŸï¼ˆ1-3å¤©ï¼‰å»ºè®®
   - ä¸­æœŸï¼ˆ1-2å‘¨ï¼‰å»ºè®®
   - é£é™©æç¤º

## è¾“å‡ºæ ¼å¼

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºï¼š

```markdown
## ğŸ“Š æ ¸å¿ƒè¦ç‚¹

1. **[äº‹ä»¶åç§°]** - [å½±å“æ–¹å‘]: [ç®€è¦åˆ†æ]
2. ...

## ğŸ¯ æ¿å—å½±å“è¯„ä¼°

| æ¿å— | æ–¹å‘ | å½±å“ç¨‹åº¦ | ç½®ä¿¡åº¦ | ç†ç”± |
|------|------|----------|--------|------|
| ç§‘æŠ€ | åˆ©å¥½ | 8/10 | é«˜ | ... |

## ğŸ“ˆ å®æ—¶å¸‚åœºæ•°æ®

- **ä¸Šè¯æŒ‡æ•°**: xxxx.xx (Â±x.xx%)
- **ç›¸å…³è‚¡ç¥¨**: ...

## ğŸ’¡ æŠ•èµ„å»ºè®®

**çŸ­æœŸï¼ˆ1-3å¤©ï¼‰**ï¼š...

**ä¸­æœŸï¼ˆ1-2å‘¨ï¼‰**ï¼š...

**é£é™©æç¤º**ï¼š...
```

è¦æ±‚ï¼š
- åˆ†æè¦å®¢è§‚ã€æœ‰é€»è¾‘æ”¯æ’‘
- é¿å…è¿‡åº¦ä¹è§‚æˆ–æ‚²è§‚
- æ˜ç¡®æŒ‡å‡ºä¸ç¡®å®šæ€§
- ä½¿ç”¨ä¸“ä¸šä½†æ˜“æ‡‚çš„è¯­è¨€
- å……åˆ†åˆ©ç”¨å·¥å…·è·å–å®æ—¶æ•°æ®å¢å¼ºåˆ†æ
"""

    # å¿«é€Ÿæ‘˜è¦ Promptï¼ˆç”¨äºç”Ÿæˆæè¿°ï¼‰
    SUMMARY_PROMPT = """è¯·ç”¨ä¸€å¥è¯æ€»ç»“ä»¥ä¸‹æ–°é—»çš„æ ¸å¿ƒå¸‚åœºå½±å“ï¼ˆä¸è¶…è¿‡50å­—ï¼‰ï¼š

{news_summary}

è¦æ±‚ï¼šçªå‡ºæœ€é‡è¦çš„å¸‚åœºä¿¡å·ï¼Œè¯­è¨€ç®€æ´å‡ç»ƒã€‚
"""

    @classmethod
    def build_analysis_prompt(
        cls,
        date: str,
        hot_keywords: List[str],
        news_items: List[Dict],
        focus_sectors: List[str] = None
    ) -> str:
        """
        æ„å»ºå¸‚åœºåˆ†æ Prompt
        
        Args:
            date: æ–°é—»æ—¥æœŸ
            hot_keywords: çƒ­è¯åˆ—è¡¨
            news_items: æ–°é—»æ¡ç›®åˆ—è¡¨ [{"title": ..., "url": ..., "source": ...}]
            focus_sectors: èšç„¦æ¿å—åˆ—è¡¨
            
        Returns:
            å®Œæ•´çš„åˆ†æ Prompt
        """
        if focus_sectors is None:
            focus_sectors = ["ç§‘æŠ€", "é‡‘è", "æ¶ˆè´¹", "åŒ»ç–—"]
        
        # æ ¼å¼åŒ–çƒ­è¯
        keywords_str = "ã€".join(hot_keywords[:10])
        
        # æ ¼å¼åŒ–æ–°é—»æ¡ç›®
        news_lines = []
        for i, item in enumerate(news_items[:30], 1):  # é™åˆ¶æœ€å¤š30æ¡æ–°é—»
            title = item.get("title", "")
            source = item.get("source", "")
            news_lines.append(f"{i}. {title} ({source})")
        
        news_items_str = "\n".join(news_lines)
        
        # æ ¼å¼åŒ–èšç„¦æ¿å—
        sectors_str = "ã€".join(focus_sectors)
        
        return cls.MARKET_ANALYSIS_PROMPT.format(
            date=date,
            hot_keywords=keywords_str,
            news_items=news_items_str,
            focus_sectors=sectors_str
        )
    
    @classmethod
    def build_summary_prompt(cls, news_summary: str) -> str:
        """
        æ„å»ºæ‘˜è¦ Prompt
        
        Args:
            news_summary: æ–°é—»æ‘˜è¦å†…å®¹
            
        Returns:
            æ‘˜è¦ Prompt
        """
        return cls.SUMMARY_PROMPT.format(news_summary=news_summary)
    
    @classmethod
    def get_system_messages(cls) -> List[Dict]:
        """
        è·å–ç³»ç»Ÿæ¶ˆæ¯ï¼ˆç”¨äº API è°ƒç”¨ï¼‰
        
        Returns:
            ç³»ç»Ÿæ¶ˆæ¯åˆ—è¡¨
        """
        return [
            {
                "role": "system",
                "content": cls.SYSTEM_ROLE
            }
        ]
